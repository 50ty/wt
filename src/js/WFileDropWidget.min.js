WT_DECLARE_WT_MEMBER(1,JavaScriptConstructor,"WFileDropWidget",function(l,b,r){jQuery.data(b,"lobj",this);var c=this,p="Wt-dropzone-hover",e=[],q=false,j=true,n=false,o=false,k=0,i=document.createElement("input");i.type="file";i.setAttribute("multiple","multiple");$(i).hide();b.appendChild(i);var h=document.createElement("div");$(h).addClass("Wt-dropcover");document.body.appendChild(h);this.eventContainsFile=function(a){var d=a.dataTransfer.types!=null&&a.dataTransfer.types.length>0&&a.dataTransfer.types[0]==
"Files";return a.dataTransfer.items!=null&&a.dataTransfer.items.length>0&&a.dataTransfer.items[0].kind=="file"||d};this.validFileCheck=function(a,d,g){var f=new FileReader;f.onload=function(){d(true,g)};f.onerror=function(){d(false,g)};f.readAsText(a.slice(0,32))};b.setAcceptDrops=function(a){j=a};b.setDropIndication=function(a){n=a};b.setDropForward=function(a){o=a};b.ondragenter=function(a){if(j){if(c.eventContainsFile(a)){k===0&&c.setPageHoverStyle();k=2;c.setWidgetHoverStyle(true)}a.stopPropagation()}};
b.ondragleave=function(a){var d=a.clientX;a=a.clientY;var g=document.elementFromPoint(d,a);if(d===0&&a===0)g=null;if(g===h){c.setWidgetHoverStyle(false);k=1}else c.resetDragDrop()};b.ondragover=function(a){a.preventDefault()};bodyDragEnter=function(){if((n||o)&&$(b).is(":visible")){k=1;c.setPageHoverStyle()}};document.body.addEventListener("dragenter",bodyDragEnter);h.ondragover=function(a){a.preventDefault();a.stopPropagation()};h.ondragleave=function(){!j||k!=1||c.resetDragDrop()};h.ondrop=function(a){a.preventDefault();
o?b.ondrop(a):c.resetDragDrop()};b.ondrop=function(a){a.preventDefault();if(j){c.resetDragDrop();window.FormData===undefined||a.dataTransfer.files==null||a.dataTransfer.files.length==0||c.addFiles(a.dataTransfer.files)}};this.addFiles=function(a){for(var d=[],g=0;g<a.length;g++){var f=new XMLHttpRequest;f.id=Math.floor(Math.random()*Math.pow(2,31));f.file=a[g];e.push(f);var m={};m.id=f.id;m.filename=f.file.name;m.type=f.file.type;m.size=f.file.size;d.push(m)}l.emit(b,"dropsignal",JSON.stringify(d))};
b.addEventListener("click",function(){if(j){$(i).val("");i.click()}});b.markForSending=function(a){for(var d=0;d<a.length;d++)for(var g=a[d].id,f=0;f<e.length;f++)if(e[f].id==g){e[f].ready=true;break}q||e[0].ready&&c.requestSend()};this.requestSend=function(){if(e[0].skip)c.uploadFinished(null);else{q=true;l.emit(b,"requestsend",e[0].id)}};b.send=function(a){xhr=e[0];if(xhr.file.size>r){l.emit(b,"filetoolarge",xhr.file.size);c.uploadFinished(null)}else c.validFileCheck(xhr.file,c.actualSend,a)};this.actualSend=
function(a,d){if(a){xhr=e[0];xhr.addEventListener("load",c.uploadFinished);xhr.addEventListener("error",c.uploadFinished);xhr.addEventListener("abort",c.uploadFinished);xhr.addEventListener("timeout",c.uploadFinished);xhr.open("POST",d);a=new FormData;a.append("file-id",xhr.id);a.append("data",xhr.file);xhr.send(a)}else c.uploadFinished(null)};this.uploadFinished=function(a){a!=null&&a.type=="load"&&a.currentTarget.status==200&&l.emit(b,"uploadfinished",e[0].id);e.splice(0,1);if(e[0]&&e[0].ready)c.requestSend();
else{q=false;l.emit(b,"donesending")}};b.cancelUpload=function(a){if(e[0]&&e[0].id==a)e[0].abort();else for(var d=1;d<e.length;d++)if(e[d].id==a)e[d].skip=true};i.onchange=function(){if(j)window.FormData===undefined||this.files==null||this.files.length==0||c.addFiles(this.files)};this.setPageHoverStyle=function(){if(n||o){$(h).addClass("Wt-dropzone-dragstyle");$(b).addClass("Wt-dropzone-dragstyle");n&&$(b).addClass("Wt-dropzone-indication")}};this.setWidgetHoverStyle=function(a){a?$(b).addClass(p):
$(b).removeClass(p)};this.resetDragDrop=function(){$(b).removeClass("Wt-dropzone-indication");$(b).removeClass("Wt-dropzone-dragstyle");$(h).removeClass("Wt-dropzone-dragstyle");c.setWidgetHoverStyle(false);k=0};b.configureHoverClass=function(a){p=a};b.setFilters=function(a){i.setAttribute("accept",a)};b.destructor=function(){document.body.removeEventListener("dragenter",bodyDragEnter);document.body.removeChild(h)}});
